function number_format(e,t,n,a){e=(e+"").replace(/[^0-9+\-Ee.]/g,"");var o=isFinite(+e)?+e:0,r=isFinite(+t)?Math.abs(t):0,i="undefined"==typeof a?",":a,s="undefined"==typeof n?".":n,l="",c=function(e,t){var n=Math.pow(10,t);return""+Math.round(e*n)/n};return l=(r?c(o,r):""+Math.round(o)).split("."),l[0].length>3&&(l[0]=l[0].replace(/\B(?=(?:\d{3})+(?!\d))/g,i)),(l[1]||"").length<r&&(l[1]=l[1]||"",l[1]+=new Array(r-l[1].length+1).join("0")),l.join(s)}function precise_round(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)}function _time_to_string(e){var t=parseInt(e/3600)%24,n=parseInt(e/60)%60,a=e%60,o=86400;return o>e?pad(precise_round(t,0))+":"+pad(precise_round(n,0))+":"+pad(precise_round(a,0)):"1 day"}function pad(e){return e>9?e:"0"+e}function freeze_menu(e){var t=new Array;t[0]="dashboard",t[1]="objectmanager",t[2]="make/history",t[3]=e;var n=$("nav li > a");n.each(function(){var n=$(this).attr("data-controller");jQuery.inArray(n,t)>=0?n==e&&$(this).append('<span class="badge bg-color-red pull-right inbox-badge freeze-menu">!</span>'):($(this).addClass("menu-disabled"),$(this).removeAttr("href"))})}function unfreeze_menu(){$("#left-panel a").each(function(e,t){$(this).removeClass("menu-disabled"),$(this).attr("href",$(this).attr("data-href"))}),$(".freeze-menu").remove(),freezed=!1}function bytesToSize(e){var t=1e3,n=["B","Kb","Mb","Gb","Tb"];if(0===e)return"0 Bytes";var a=parseInt(Math.floor(Math.log(e)/Math.log(t)),10);return parseFloat(e/Math.pow(t,a)).toFixed(3)+" "+n[a]}function safety(){return PAGE_ACTIVE&&do_system_call?SOCKET_CONNECTED?!1:void(0==EMERGENCY&&$.get("/temp/fab_ui_safety.json?time="+jQuery.now(),function(e){"emergency"==e.type&&show_emergency(e.code)})):!1}function secure(e){SOCKET_CONNECTED?SOCKET.send("message",'{"name": "secure", "data":{"mode":'+e+" } }"):(IS_MACRO_ON=!0,$.ajax({type:"POST",url:"/fabui/application/modules/controller/ajax/secure.php",data:{mode:e},dataType:"json"}).done(function(e){EMERGENCY=!1,IS_MACRO_ON=!1}))}function set_tasks(e){IS_TASK_ON=!1,number_tasks=e.number;var t="";$(".task-list").find("span").html("	Tasks ("+e.number+") "),e.number>0&&(IS_TASK_ON=!0,$.each(e.items,function(){var e=this;t=e.controller,"make"==t&&(t+="/"+e.type)})),e.number>0?(freeze_menu(t),freezed=!0):(freezed=!1,unfreeze_menu())}function set_updates(e){if(number_updates=e,$(".update-list").find("span").html("	Updates ("+e+") "),e>0&&$("#left-panel").find("nav").find("ul").find("li").each(function(){"updates"==$(this).find("a").attr("data-controller")&&$(this).find("a").append('<span class="badge bg-color-red pull-right inbox-badge">'+e+"</span>")}),number_updates>0){var t='<div class="row"><div class="col-sm-12"><div class="alert alert-danger alert-block animated bounce"><button class="close" data-dismiss="alert">×</button><h4 class="alert-heading"> <i class="fa fa-refresh"></i> New important software updates are now available, <a style="text-decoration:underline; color:white;" href="/fabui/updates">update now!</a> </h4></div></div></div>';"updates"!=MODULE&&$("#content").prepend(t)}}function update_notifications(){var e=number_updates+number_tasks+number_notifications;e>0?($("#activity").find(".badge").addClass("bg-color-red bounceIn animated"),document.title=PAGE_TITLE+" ("+e+")"):($("#activity").find(".badge").removeClass("bg-color-red bounceIn animated"),document.title=PAGE_TITLE),0==number_tasks&&(freezed=!1,unfreeze_menu()),$("#activity").find(".badge").html(e)}function refresh_notifications(){return PAGE_ACTIVE&&do_system_call?void $(".notification").each(function(e,t){var n=$(this);if(n.hasClass("active")){var a=n.find('input[name="activity"]').attr("id"),o=$(".ajax-notifications");loadURL(a,o)}}):!1}function check_notifications(){if(!PAGE_ACTIVE)return!1;if(!do_system_call)return!1;if(SOCKET_CONNECTED)return!1;if(IDLETIME<max_idle_time||0==max_idle_time){var e=(new Date).getTime();$.ajax({type:"POST",url:"/fabui/application/modules/controller/ajax/check_notifications.php?time="+e,dataType:"json",cache:!1}).done(function(e){set_tasks(e.tasks),update_notifications(),1==e.internet?$(".internet").show():$(".internet").hide()})}else lockscreen()}function timerIncrement(){IDLETIME++,max_idle_time>0&&IDLETIME>max_idle_time&&lockscreen()}function lockscreen(){$("#lock-screen-form").submit()}function shutdown(){IS_MACRO_ON=!0,openWait('<i class="fa fa-circle-o-notch fa-spin"></i> Shutdown in progress'),clearInterval(notifications_interval),clearInterval(safety_interval),clearInterval(idleInterval),$.get("/fabui/application/modules/controller/ajax/shutdown.php",function(){setTimeout(function(){waitTitle("Now you can switch off the power"),showShutdownImage(),closeWait(),IS_MACRO_ON=!1},15e3)})}function showShutdownImage(){var e=function(){return{initFancybox:function(){jQuery(".fancybox-shutdown").fancybox({groupAttr:"data-rel",openEffect:"elastic",modal:!0,titleShow:!0,titlePosition:"over",helpers:{title:{type:"float"}}}),$(".fbox-modal").fancybox({maxWidth:800,maxHeight:600,fitToView:!1,width:"70%",height:"70%",autoSize:!1,closeClick:!1,closeEffect:"fade",openEffect:"elastic"})}}}();e.initFancybox(),$(".fancybox-shutdown").trigger("click")}function restart(){IS_MACRO_ON=!0,openWait("<i class='fa fa-circle-o-notch fa-spin'></i> Restart in progress"),clearInterval(notifications_interval),clearInterval(safety_interval),clearInterval(idleInterval),$.get("/fabui/application/modules/controller/ajax/restart.php",function(){waitContent("Restarting please wait..."),setTimeout(function(){IS_MACRO_ON=!1,document.location.href="/fabui/login/out"},85e3)})}function check_for_updates(){$.get("/fabui/updates/check",function(e,t){0==e.updates.updated&&(set_updates(1),update_notifications())})}function dont_ask_wizard(){$.ajax({type:"POST",url:"/fabui/controller/wizard",dataType:"json",data:{set:0}}).done(function(e){})}function finalize_wizard(){$.ajax({type:"POST",url:"/fabui/application/modules/maintenance/ajax/finish_wizard.php",dataType:"json"}).done(function(e){})}function getTrace(e,t,n){$.ajax({type:t,url:e}).done(function(e,t,a){200==a.status&&(n.html(e),n.scrollTop(1e10))})}function show_emergency(e){if(jogFirstEntry=!0,1!=EMERGENCY){EMERGENCY=!0;var t="[OK][IGNORE]";e==parseInt(103)&&(t="[IGNORE] [INSTALL HEAD]"),$.SmartMessageBox({title:"<h4><span class='txt-color-orangeDark'><i class='fa fa-warning fa-2x'></i></span>&nbsp;&nbsp;"+decode_emergency_code(e)+"<br>&nbsp;Press OK to continue or Ignore to disable this warning</h4>",buttons:t},function(e){"OK"===e&&secure(1),"IGNORE"===e&&secure(t.indexOf("INSTALL HEAD")>-1?1:0),"INSTALL HEAD"===e&&installHead()})}}function show_alert(e){$.smallBox({title:"Message",content:decode_emergency_code(e),color:"#5384AF",timeout:1e4,icon:"fa fa-warning"})}function decode_emergency_code(e){switch(parseInt(e)){case 100:return"General Safety Lockdown";case 101:return"Printer stopped due to errors";case 102:return"Front panel is open, cannot continue";case 103:return"Head not properly aligned or absent";case 104:return"Extruder Temperature critical, shutting down";case 105:return"Bed Temperature critical, shutting down";case 106:return'X max Endstop hit: Move the carriage to the center or check <span class="txt-color-orangeDark"><strong>Settings > Hardware > Custom Settings > Invert X Endstop Logic</strong></span>';case 107:return'X min Endstop hit: Move the carriage to the center or check <span class="txt-color-orangeDark"><strong>Settings > Hardware > Custom Settings >Invert X Endstop Logic</strong></span>';case 108:return"Y max Endstop hit: Move the carriage to the center and reset";case 109:return"Y min Endstop hit: Move the carriage to the center and reset";case 110:return"The FABtotum has been idling for more than 10 minutes. Temperatures and Motors have been turned off.";case 120:return"Both Y Endstops hit at the same time";case 121:return"Both Z Endstops hit at the same time";case 122:return"Ambient temperature is less then 15°C. Cannot continue.";case 123:return"Cannot extrude filament: the nozzle temperature is too low";case 124:return"Cannot extrude so much filament!";default:return"Unknown error Error code: "+e}}function show_connected(e){if(e)$(".internet").show(),$(".no-internet-detected").remove();else if($(".internet").hide(),$(".no-internet-detected").length<=0){var t='<div class="row no-internet-detected"><div class="col-sm-12"><div class="alert alert-warning alert-block animated  bounce"><button class="close" data-dismiss="alert">×</button><h4 class="alert-heading"><i class="fa fa-warning"></i>   No internet connectivity detected. For a better experience please <a style="text-decoration:underline;" href="/fabui/settings/network/wlan">connect</a> </h4></div></div></div>';$("#content").prepend(t)}}function check_connected(){SOCKET_CONNECTED&&PAGE_ACTIVE&&SOCKET.send("message",'{"name": "getInternet"}')}function socket_fallback(){SOCKET_CONNECTED=!1}function write_to_console(e,t){t=t||"","macro"==t||"task"==t?($(".console").html(e),waitContent(e)):$(".console").append(e),$(".console").scrollTop(1e10),waitContent(e)}function manage_macro(e){"trace"==e.type?write_to_console(e.content,"macro"):"response"==e.type?manage_macro_response(e.content):"status"==e.type}function manage_task(e){"trace"==e.type?write_to_console(e.content,"task"):"monitor"==e.type&&manage_task_monitor(e)}function manage_task_monitor(e){}function manage_macro_response(e){}function manage_system_monitor(e){switch(e.type){case"usb":mange_usb_monitor(e.status,e.alert);break;case"lock":manage_lock_file(e.status,e.alert)}}function manage_post_processing(e){}function mange_usb_monitor(e,t){var n="<p><strong>";e?(n+="Usb disk inserted",$(".usb-ribbon").show()):(n+="Usb disk removed",$(".usb-ribbon").hide()),n+="</strong></p>",t&&$.smallBox({title:"System",content:n,color:"#296191",timeout:3e3,icon:"icon-fab-usb"})}function manage_lock_file(e,t){}function reset_controller(){RESETTING_CONTROLLER=!0,openWait('<i class="fa fa-circle-o-notch fa-spin"></i> Resetting controller'),$.get("/fabui/application/modules/controller/ajax/reset_controller.php",function(){closeWait(),RESETTING_CONTROLLER=!1})}function stopAll(e){e=e||"Aborting all operations ",openWait(e," ",!1),STOPPING_ALL=!0,$.get("/fabui/application/modules/controller/ajax/stop_all.php",function(){waitContent("Refreshing page"),setTimeout(function(){location.reload()},3e3)})}function jog_call(e,t){SOCKET_CONNECTED?jog_make_call_ws(e,t):"function"==typeof make_jog_call?make_jog_call(e,t):jog_make_call_ajax(e,t)}function jog_make_call_ws(e,t){var n={};n.func=e,n.value=t,n.step=$("#step").length>0?$("#step").val():10,n.z_step=$("#z-step").length>0?$("#z-step").val():5,n.feedrate=$("#feedrate").length>0?$("#feedrate").val():1e3,n.extruderFeedrate=$("#extruder-feedrate").length>0?$("#extruder-feedrate").val():300;var a={};a.name="serial",a.data=n,SOCKET.send("message",JSON.stringify(a))}function jog_make_call_ajax(e,t){var n={};n["function"]=e,n.value=t,n.step=$("#step").length>0?$("#step").val():10,n.z_step=$("#z-step").length>0?$("#z-step").val():5,n.feedrate=$("#feedrate").length>0?$("#feedrate").val():1e3,n.extruderFeedrate=$("#extruder-feedrate").length>0?$("#extruder-feedrate").val():300,$.ajax({type:"POST",url:"/fabui/application/modules/jog/ajax/exec.php",data:n,dataType:"json"}).done(function(e){})}function get_temperatures(){RESETTING_CONTROLLER||STOPPING_ALL||IS_MACRO_ON||IS_TASK_ON||PRINTER_BUSY||SOCKET_CONNECTED&&jog_call("get_temperature","")}function update_temperature_info(e){if(e.response.indexOf("ok T:")>-1){var t=e.response.replace("ok ",""),n=t.split(" "),a=n[0].split(":")[1],o=n[1].split("/")[1],r=n[2].split(":")[1],i=n[3].split("/")[1];$("#top-bar-nozzle-actual").html(parseInt(a)),$("#top-bar-nozzle-target").html(parseInt(o)),$("#top-bar-bed-actual").html(parseInt(r)),$("#top-bar-bed-target").html(parseInt(i)),$("#top-act-ext-temp").length>0&&(document.getElementById("top-act-ext-temp").noUiSlider.set([parseInt(a)]),document.getElementById("top-ext-target-temp").noUiSlider.set([parseInt(o)])),document.getElementById("top-act-bed-temp").noUiSlider.set([parseInt(r)]),document.getElementById("top-bed-target-temp").noUiSlider.set([parseInt(i)]),"undefined"!=typeof Storage&&(localStorage.setItem("nozzle_temp",a),localStorage.setItem("nozzle_temp_target",o),localStorage.setItem("bed_temp",r),localStorage.setItem("bed_temp_target",i)),"jog"==MODULE&&($("#act-ext-temp").length>0&&($("#ext-actual-degrees").html(parseInt(a)+"&deg;C"),document.getElementById("act-ext-temp").noUiSlider.set([parseInt(a)]),document.getElementById("ext-target-temp").noUiSlider.set([parseInt(o)])),$("#bed-actual-degrees").html(parseInt(r)+"&deg;C"),document.getElementById("act-bed-temp").noUiSlider.set([parseInt(r)]),document.getElementById("bed-target-temp").noUiSlider.set([parseInt(i)]),showTemperatureConsole&&(write_to_console("Temperatures (M105) [Ext: "+parseInt(a)+" / "+parseInt(o)+" ---  Bed: "+parseInt(r)+" / "+parseInt(i)+"]\n"),showTemperatureConsole=!1))}}function checkExit(){return 0==STOPPING_ALL&&1==IS_MACRO_ON?"You have attempted to leave this page. The Fabtotum Personal Fabricator is still working. Are you sure you want to reload this page?":void 0}function initUI(){$(".directions").on("click",directions),$(".axisz").on("click",axisz),$(".zero_all").on("click",zero_all),"undefined"!=typeof Storage&&($("#top-bar-nozzle-actual").html(parseInt(localStorage.getItem("nozzle_temp"))),$("#top-bar-nozzle-target").html(parseInt(localStorage.getItem("nozzle_temp_target"))),$("#top-bar-bed-actual").html(parseInt(localStorage.getItem("bed_temp"))),$("#top-bar-bed-target").html(parseInt(localStorage.getItem("bed_temp_target")))),noUiSlider.create(document.getElementById("top-bed-target-temp"),{start:"undefined"!=typeof Storage?localStorage.getItem("bed_temp_target"):0,connect:"lower",range:{min:0,max:100},pips:{mode:"positions",values:[0,25,50,75,100],density:5,format:wNumb({postfix:"&deg;"})}}),noUiSlider.create(document.getElementById("top-act-bed-temp"),{start:"undefined"!=typeof Storage?localStorage.getItem("bed_temp"):0,connect:"lower",range:{min:0,max:100},behaviour:"none"}),$("#top-act-bed-temp .noUi-handle").remove(),$("#top-ext-target-temp").length>0&&(noUiSlider.create(document.getElementById("top-ext-target-temp"),{start:"undefined"!=typeof Storage?localStorage.getItem("nozzle_temp_target"):0,connect:"lower",range:{min:0,max:MAX_NOZZLE_TEMP},pips:{mode:"positions",values:[0,25,50,75,100],density:5,format:wNumb({postfix:"&deg;"})}}),noUiSlider.create(document.getElementById("top-act-ext-temp"),{start:"undefined"!=typeof Storage?localStorage.getItem("nozzle_temp"):0,connect:"lower",range:{min:0,max:MAX_NOZZLE_TEMP},behaviour:"none"}),document.getElementById("top-ext-target-temp").noUiSlider.on("slide",topExtTempSlide),document.getElementById("top-ext-target-temp").noUiSlider.on("change",topExtTempChange),document.getElementById("top-ext-target-temp").noUiSlider.on("start",blockSliders),document.getElementById("top-ext-target-temp").noUiSlider.on("end",enableSliders),$("#top-act-ext-temp .noUi-handle").remove()),document.getElementById("top-bed-target-temp").noUiSlider.on("slide",topBedTempSlide),document.getElementById("top-bed-target-temp").noUiSlider.on("change",topBedTempChange),document.getElementById("top-bed-target-temp").noUiSlider.on("start",blockSliders),document.getElementById("top-bed-target-temp").noUiSlider.on("end",enableSliders)}function blockSliders(){}function enableSliders(){}function topExtTempSlide(e){$("#top-bar-nozzle-target").html(parseInt(e[0])),$("#ext-degrees").html(parseInt(e[0])+"&deg;C"),$("#ext-target-temp").length>0&&document.getElementById("ext-target-temp").noUiSlider.set([parseInt(e[0])])}function topExtTempChange(e){jog_call("ext_temp",parseInt(e[0]))}function topBedTempSlide(e){$("#top-bar-bed-target").html(parseInt(e[0])),$("#bed-degrees").html(parseInt(e[0])+"&deg;C"),$("#bed-target-temp").length>0&&document.getElementById("bed-target-temp").noUiSlider.set([parseInt(e[0])])}function topBedTempChange(e){jog_call("bed_temp",parseInt(e[0]))}function installHead(){document.location.href="/fabui/maintenance/head?warning=1"}function directions(){var e=$(this).attr("data-attribue-direction");jog_call("directions",e)}function axisz(){var e=$(this).attr("data-attribute-function"),t=$(this).attr("data-attribute-step");jog_call(e,t)}function zero_all(){jog_call("zero_all",!0)}function disable_button(e){$(e).addClass("disabled"),$(e).prop("disabled",!0)}function enable_button(e){$(e).removeClass("disabled"),$(e).prop("disabled",!1)}function RefreshTable(e,t){$(e+"_wrapper").css({opacity:.3}),$.getJSON(t,null,function(t){table=$(e).dataTable(),oSettings=table.fnSettings(),table.fnClearTable(this);for(var n=0;n<t.aaData.length;n++)table.oApi._fnAddData(oSettings,t.aaData[n]);oSettings.aiDisplay=oSettings.aiDisplayMaster.slice(),table.fnDraw(),$(e+"_wrapper").css({opacity:1})})}var notifications_interval,safety_interval,tasks_interval,EMERGENCY=!1,IDLETIME=0,idleInterval,do_system_call=!0,SOCKET,SOCKET_CONNECTED=!1,interval_internet,jogFirstEntry=!0,PAGE_ACTIVE=!0,PAGE_TITLE="",RESETTING_CONTROLLER=!1,STOPPING_ALL=!1,IS_MACRO_ON=!1,IS_TASK_ON=!1,jog_ticket_url="",interval_temperature,BLOCK_TEMP_EXT_SLIDER=!1;$(function(){if(PAGE_TITLE=document.title,fabui){if("WebSocket"in window){var e=window.location.hostname,t=9001;SOCKET=new FabWebSocket(e,t),SOCKET.bind("message",function(e){try{var t=jQuery.parseJSON(e)}catch(n){return}switch(t.type){case"emergency":if(102==parseInt(t.code))return void stopAll("Front panel has been opened.<br> Aborting all operations");show_emergency(t.code);break;case"alert":show_alert(t.code);break;case"security":EMERGENCY=!1;break;case"internet":show_connected(t.data);break;case"serial":write_to_console(t.data.command+": "+t.data.response);break;case"temperature":"function"==typeof update_temperature_info&&update_temperature_info(t.data);break;case"error":break;case"macro":manage_macro(t.data);break;case"task":"notifications"==t.data.type?(set_tasks(t.data),update_notifications()):manage_task(t.data);break;case"create":"function"==typeof create_socket_response&&create_socket_response(t.data);break;case"system":manage_system_monitor(t.data);break;case"post_processing":manage_post_processing(t.data)}}),SOCKET.bind("open",function(){SOCKET_CONNECTED=!0,SOCKET.send("message",'{"name": "getTasks"}'),SOCKET.send("message",'{"name": "getInternet"}'),SOCKET.send("message",'{"name": "getUsb"}')}),SOCKET.bind("close",function(){SOCKET_CONNECTED=!1,socket_fallback()}),SOCKET.bind("error",function(){socket_fallback()}),interval_internet=setInterval(check_connected,36e4),SOCKET.connect()}initUI(),notifications_interval=setInterval(check_notifications,1e4),idleInterval=setInterval(timerIncrement,1e3),safety_interval=setInterval(safety,3e3),interval_temperature=setInterval(get_temperatures,2500),$("#refresh-notifications").on("click",refresh_notifications),check_for_updates()}}),$(document).mousemove(function(e){IDLETIME=0}),$("#send-suggestion").on("click",function(){return""==$.trim($("#suggestion-text").val())?!1:($(".modal-content").find(".btn").addClass("disabled"),$("#send-suggestion").html('<i class="fa fa-envelope-o"></i> Sending..'),void $.ajax({type:"POST",url:"/fabui/controller/suggestion",dataType:"json",data:{text:$("#suggestion-text").val(),title:$("#suggestion-title").val()}}).done(function(e){$(".modal-content").find(".btn").removeClass("disabled"),$("#send-suggestion").html('<i class="fa fa-envelope-o"></i> Send'),1==e.result?($("#suggestion-text").val(""),$("#suggestion-title").val(""),$(".suggestion-modal").modal("hide"),$.smallBox({title:"Thanks",content:"so much for taking the time to help improve FABUI .",color:"#659265",iconSmall:"fa fa-smile-o fa-2X",timeout:7e3})):$.smallBox({title:"Warning",content:"an error occurred, please try to send again",color:"#C46A69",iconSmall:"fa fa-warning shake animated",timeout:7e3})}))}),$("#send-bug").on("click",function(){return""==$.trim($("#bug-text").val())?!1:($(".modal-content").find(".btn").addClass("disabled"),$("#send-bug").html('<i class="fa fa-envelope-o"></i> Sending..'),void $.ajax({type:"POST",url:"/fabui/controller/bug",dataType:"json",data:{text:$("#bug-text").val(),title:$("#bug-title").val()}}).done(function(e){$(".modal-content").find(".btn").removeClass("disabled"),$("#send-bug").html('<i class="fa fa-envelope-o"></i> Send'),1==e.result?($("#bug-text").val(""),$("#bug-title").val(""),$(".bug-modal").modal("hide"),$.smallBox({title:"Thanks",content:"so much for taking the time to help improve FABUI .",color:"#659265",iconSmall:"fa fa-smile-o fa-2X",timeout:7e3})):$.smallBox({title:"Warning",content:"an error occurred, please try to send again",color:"#C46A69",iconSmall:"fa fa-warning shake animated",timeout:7e3})}))});